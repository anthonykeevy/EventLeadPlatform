# Epic 1: Authentication & Onboarding - Complete Story Breakdown

**Epic Status:** Ready for Implementation  
**Stories Created:** 11 (0.1-0.3 ‚úÖ Completed, 1.1-1.8 Ready)  
**Generated:** 2025-10-16

---

## üìä Story Pipeline Overview

### **Phase 1: Infrastructure & Foundation** ‚úÖ COMPLETE

| Story | Title | Status | Lines | Completed By |
|-------|-------|--------|-------|--------------|
| **0.1** | Database Models & Core Infrastructure | ‚úÖ Approved | 324 | Amelia |
| **0.2** | Automated Logging Infrastructure | ‚úÖ Approved | 556 | Amelia |
| **0.3** | Email Service Foundation | ‚úÖ Approved | 895 | Amelia |

**Phase 1 Summary:**
- ‚úÖ 33 SQLAlchemy models (45 database tables)
- ‚úÖ Request logging middleware
- ‚úÖ Global exception handler
- ‚úÖ Email service with MailHog and SMTP providers
- ‚úÖ Email templates with responsive design
- ‚úÖ All dependencies committed to git

---

### **Phase 2: Authentication & Authorization** üìù READY

| Story | Title | Status | Lines | AC Count | Tasks |
|-------|-------|--------|-------|----------|-------|
| **1.1** | User Signup & Email Verification | Ready | ~600 | 10 | 13 |
| **1.2** | Login & JWT Tokens | Ready | ~550 | 10 | 13 |
| **1.3** | RBAC Middleware & Authorization | Ready | ~650 | 10 | 13 |

**Phase 2 Deliverables:**
- Public signup endpoint with email verification
- Password strength validation (8+ chars, uppercase, lowercase, number, special char)
- Email verification tokens (24-hour expiry)
- Login endpoint with JWT tokens
- Access tokens (1-hour expiry) + refresh tokens (7-day expiry)
- JWT authentication middleware
- Role-based authorization decorators (`@require_role`)
- Multi-tenant company context
- Protected endpoint patterns

**Key Features:**
- Bcrypt password hashing
- Cryptographically secure tokens
- Automatic email sending (verification emails)
- JWT payload includes: user_id, email, role, company_id
- Request context integration for logging

---

### **Phase 3: Protected Endpoints - Onboarding & Team** üìù READY

| Story | Title | Status | Lines | AC Count | Tasks |
|-------|-------|--------|-------|----------|-------|
| **1.4** | Password Reset Flow | Ready | ~350 | 10 | 9 |
| **1.5** | First-Time User Onboarding | Ready | ~380 | 10 | 7 |
| **1.6** | Team Invitation System | Ready | ~420 | 10 | 10 |
| **1.7** | Invited User Acceptance & Onboarding | Ready | ~450 | 10 | 8 |

**Phase 3 Deliverables:**
- Password reset request + confirmation endpoints
- Password reset tokens (1-hour expiry)
- User profile completion (phone, timezone)
- Company creation endpoint
- UserCompany relationship with role assignment
- Team invitation system (company_admin only)
- Invitation tokens (7-day expiry)
- Invitation acceptance flow
- Multi-company support (users can belong to multiple companies)
- Company switching functionality

**User Flows:**
1. **Password Reset:** Request ‚Üí Email ‚Üí Token validation ‚Üí New password
2. **Onboarding:** Signup ‚Üí Verify ‚Üí Complete profile ‚Üí Create company ‚Üí Become admin
3. **Team Invitation:** Admin invites ‚Üí Email sent ‚Üí Invitee accepts ‚Üí Joins company
4. **Multi-Company:** User can belong to multiple companies and switch between them

---

### **Phase 4: Multi-Tenancy** üìù READY

| Story | Title | Status | Lines | AC Count | Tasks |
|-------|-------|--------|-------|----------|-------|
| **1.8** | Multi-Tenant Data Isolation & Testing | Ready | ~500 | 10 | 10 |

**Phase 4 Deliverables:**
- Multi-tenant query helpers
- Company filtering on all company-scoped endpoints
- Comprehensive data isolation tests
- Role-based access control tests
- Security tests (JWT forgery, role escalation attempts)
- Performance tests (query overhead)
- Cross-company access logging
- Multi-tenant testing utilities

**Security Features:**
- Automatic company_id filtering from JWT
- Users cannot access other companies' data
- Role requirements enforced on all endpoints
- Failed access attempts logged
- Database constraints prevent data leaks

---

## üéØ Implementation Sequence (Correct Order)

### **Critical Dependency Chain:**

```
Story 0.1 (Database Models)
    ‚Üì
Story 0.2 (Logging Infrastructure) + Story 0.3 (Email Service)
    ‚Üì
Story 1.1 (User Signup & Email Verification)
    ‚Üì
Story 1.2 (Login & JWT Tokens)
    ‚Üì
Story 1.3 (RBAC Middleware) ‚Üê MUST BE DONE BEFORE ANY PROTECTED ENDPOINTS
    ‚Üì
Story 1.4 (Password Reset) ‚Üê Public endpoints, no RBAC needed
    ‚Üì
Story 1.5 (First-Time Onboarding) ‚Üê Requires RBAC (protected endpoints)
    ‚Üì
Story 1.6 (Team Invitation System) ‚Üê Requires RBAC (company_admin role check)
    ‚Üì
Story 1.7 (Invited User Acceptance) ‚Üê Depends on Story 1.6
    ‚Üì
Story 1.8 (Multi-Tenant Testing) ‚Üê Tests all previous stories
```

**Why Story 1.3 (RBAC) Comes Before Stories 1.5-1.7:**
- Story 1.5 (Onboarding) needs authentication for protected endpoints
- Story 1.6 (Invitations) needs `company_admin` role enforcement
- Story 1.7 (Acceptance) needs multi-company context
- Story 1.3 MUST be complete before any role-based protected endpoints

---

## üìã Story Details Summary

### **Story 1.1: User Signup & Email Verification**

**Endpoints:**
- `POST /api/auth/signup` (public)
- `POST /api/auth/verify-email` (public)

**Key Features:**
- Email uniqueness validation
- Password strength validation (8+ chars, complexity)
- Bcrypt password hashing (cost factor 12)
- User created with EmailVerified=false, IsActive=false
- Email verification token (24-hour expiry)
- Verification email sent automatically
- Token expiry enforced
- Auth events logged

**Acceptance Criteria:** 10  
**Tasks:** 13  
**Dependencies:** Stories 0.1, 0.2, 0.3

---

### **Story 1.2: Login & JWT Tokens**

**Endpoints:**
- `POST /api/auth/login` (public)
- `POST /api/auth/refresh` (public)

**Key Features:**
- Email + password authentication
- Bcrypt password verification
- Requires EmailVerified=true and IsActive=true
- JWT access token (1-hour expiry)
- JWT refresh token (7-day expiry)
- JWT payload: user_id, email, role (optional), company_id (optional)
- Refresh tokens stored in database
- Token refresh endpoint
- Auth events logged (LOGIN_SUCCESS, LOGIN_FAILED, TOKEN_REFRESH)

**Security:**
- Timing-safe password comparison
- No email existence leakage
- HTTPS required in production

**Acceptance Criteria:** 10  
**Tasks:** 13  
**Dependencies:** Story 1.1

---

### **Story 1.3: RBAC Middleware & Authorization**

**Key Features:**
- JWT authentication middleware
- Token validation (signature, expiry)
- Current user injection (request.state.user)
- Role-based authorization decorator: `@require_role("role_name")`
- Multi-tenant company context
- Public path exclusions
- Error handling (401 for auth, 403 for authorization)
- Request context integration

**Authorization Patterns:**
```python
# Pattern 1: Require authentication only
@router.get("/endpoint")
async def endpoint(current_user: CurrentUser = Depends(get_current_user)):
    pass

# Pattern 2: Require specific role
@router.post("/admin-endpoint")
@require_role("company_admin")
async def admin_endpoint(current_user: CurrentUser = Depends(get_current_user)):
    pass

# Pattern 3: Multiple roles allowed
@router.get("/dashboard")
@require_role(["company_admin", "company_user"])
async def dashboard(current_user: CurrentUser = Depends(get_current_user)):
    pass
```

**Acceptance Criteria:** 10  
**Tasks:** 13  
**Dependencies:** Story 1.2

---

### **Story 1.4: Password Reset Flow**

**Endpoints:**
- `POST /api/auth/password-reset/request` (public)
- `POST /api/auth/password-reset/confirm` (public)

**Key Features:**
- Password reset token (1-hour expiry)
- Reset email sent automatically
- No email existence leakage (security)
- New password validation
- Token single-use enforcement
- Old tokens invalidated when new one generated
- Auth events logged

**Acceptance Criteria:** 10  
**Tasks:** 9  
**Dependencies:** Stories 1.1, 1.2

---

### **Story 1.5: First-Time User Onboarding**

**Endpoints:**
- `POST /api/users/me/details` (protected)
- `POST /api/companies` (protected)

**Key Features:**
- User profile completion (phone, timezone)
- Company creation
- UserCompany relationship with role="company_admin"
- JWT refreshed with role and company_id
- ABN/ACN validation (Australian format)
- Timezone validation
- Cannot create company if already has one
- Audit logging

**Flow:**
```
1. User signs up and verifies email
2. User logs in (JWT has no role/company)
3. User completes profile details
4. User creates company
5. User becomes company_admin
6. New JWT issued with role and company_id
7. User can now access protected company endpoints
```

**Acceptance Criteria:** 10  
**Tasks:** 7  
**Dependencies:** Stories 1.1, 1.2, 1.3

---

### **Story 1.6: Team Invitation System**

**Endpoints:**
- `POST /api/companies/{company_id}/invite` (protected, company_admin)
- `GET /api/companies/{company_id}/invitations` (protected, company_admin)
- `POST /api/companies/{company_id}/invitations/{id}/resend` (protected, company_admin)
- `DELETE /api/companies/{company_id}/invitations/{id}` (protected, company_admin)

**Key Features:**
- Company admin can invite team members
- Invitation with email, role, company
- Invitation token (7-day expiry)
- Team invitation email sent
- Cannot invite existing company member
- Admin can resend invitation
- Admin can cancel invitation
- Admin can view all invitations (with status filtering)
- Audit logging

**Acceptance Criteria:** 10  
**Tasks:** 10  
**Dependencies:** Stories 1.3, 1.5

---

### **Story 1.7: Invited User Acceptance & Onboarding**

**Endpoints:**
- `GET /api/invitations/{token}` (public)
- `POST /api/invitations/{token}/accept` (protected)
- `POST /api/users/me/switch-company` (protected)

**Key Features:**
- View invitation details (company, role, inviter)
- Accept invitation (existing user)
- Signup with invitation (new user)
- UserCompany relationship created with invited role
- JWT refreshed with new role/company
- Multi-company support
- Company switching
- Email verification integration
- Audit logging

**Flows:**
```
Flow 1: Existing User
1. Receive invitation email
2. View invitation details
3. Accept invitation
4. UserCompany created
5. New JWT with updated role/company

Flow 2: New User
1. Receive invitation email
2. Sign up with invitation token
3. Verify email
4. Auto-accept invitation
5. User + UserCompany created together
6. JWT with role and company_id
```

**Acceptance Criteria:** 10  
**Tasks:** 8  
**Dependencies:** Stories 1.6, 1.1, 1.2

---

### **Story 1.8: Multi-Tenant Data Isolation & Testing**

**Key Features:**
- Multi-tenant query helpers
- Company filtering on all queries
- Data isolation tests (User A cannot access Company B's data)
- Role-based access control tests
- Security tests (JWT forgery, role escalation)
- Performance tests (query overhead)
- Cross-company access logging
- Database constraints review

**Testing Utilities:**
```python
# Create multi-tenant test scenarios
create_test_company(db, "Company A")
create_test_user(db, email, company_id, role)
create_test_data(db, company_id)

# Test data isolation
test_user_cannot_access_other_company_data()
test_company_admin_can_invite_company_user_cannot()
test_jwt_forgery_prevented()
```

**Security Checklist:**
- ‚úÖ All company-scoped endpoints filter by company_id
- ‚úÖ Company_id extracted from JWT (not request body)
- ‚úÖ Users cannot forge JWT tokens
- ‚úÖ Users cannot access other companies via direct IDs
- ‚úÖ Role requirements enforced
- ‚úÖ Failed access attempts logged
- ‚úÖ Database foreign keys enforce integrity
- ‚úÖ Indexes support efficient filtering

**Acceptance Criteria:** 10  
**Tasks:** 10  
**Dependencies:** Stories 1.3, 1.5, 1.6, 1.7

---

## üîß Technical Stack Summary

**Backend Framework:**
- FastAPI (async/await support)
- Python 3.x

**Database:**
- SQL Server
- SQLAlchemy ORM
- Alembic migrations

**Authentication:**
- JWT tokens (access + refresh)
- PyJWT library
- Bcrypt password hashing (passlib)

**Email:**
- Email service abstraction (provider pattern)
- MailHog (development)
- SMTP (production)
- Jinja2 templates

**Logging:**
- Automatic request logging
- Global exception handler
- Audit tables (audit.*)
- Log tables (log.*)

**Testing:**
- pytest
- FastAPI TestClient
- Database fixtures
- Mock objects

---

## üìÅ File Structure Summary

```
backend/
‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îú‚îÄ‚îÄ database.py           # DB connection, session management
‚îÇ   ‚îú‚îÄ‚îÄ security.py           # Password hashing, token generation
‚îÇ   ‚îú‚îÄ‚îÄ request_context.py    # Request-scoped context
‚îÇ   ‚îú‚îÄ‚îÄ log_filters.py        # Sensitive data filtering
‚îÇ   ‚îú‚îÄ‚îÄ logger.py             # Structured logging
‚îÇ   ‚îú‚îÄ‚îÄ rbac.py               # Role-based authorization
‚îÇ   ‚îú‚îÄ‚îÄ multi_tenant.py       # Multi-tenant query helpers
‚îÇ   ‚îî‚îÄ‚îÄ password_validator.py # Password strength validation
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ request_logger.py     # API request logging
‚îÇ   ‚îú‚îÄ‚îÄ exception_handler.py  # Global exception handler
‚îÇ   ‚îî‚îÄ‚îÄ auth.py               # JWT authentication middleware
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ email.py              # Email configuration
‚îÇ   ‚îî‚îÄ‚îÄ jwt.py                # JWT configuration
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ router.py         # Auth endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas.py        # Pydantic schemas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user_service.py   # User business logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ token_service.py  # Token generation/validation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt_service.py    # JWT creation/decoding
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ audit_service.py  # Auth event logging
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py         # CurrentUser model
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dependencies.py   # get_current_user dependency
‚îÇ   ‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ router.py         # User profile endpoints
‚îÇ   ‚îî‚îÄ‚îÄ companies/
‚îÇ       ‚îî‚îÄ‚îÄ router.py         # Company and invitation endpoints
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ email_service.py      # Email service
‚îÇ   ‚îî‚îÄ‚îÄ email_providers/
‚îÇ       ‚îú‚îÄ‚îÄ mailhog.py        # MailHog provider
‚îÇ       ‚îî‚îÄ‚îÄ smtp.py           # SMTP provider
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ user.py               # User model
‚îÇ   ‚îú‚îÄ‚îÄ company.py            # Company model
‚îÇ   ‚îú‚îÄ‚îÄ user_company.py       # UserCompany relationship
‚îÇ   ‚îú‚îÄ‚îÄ ref/                  # Reference tables
‚îÇ   ‚îú‚îÄ‚îÄ audit/                # Audit tables
‚îÇ   ‚îî‚îÄ‚îÄ log/                  # Log tables
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îî‚îÄ‚îÄ emails/
‚îÇ       ‚îú‚îÄ‚îÄ layouts/base.html
‚îÇ       ‚îú‚îÄ‚îÄ email_verification.html
‚îÇ       ‚îú‚îÄ‚îÄ password_reset.html
‚îÇ       ‚îî‚îÄ‚îÄ team_invitation.html
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ test_auth_signup.py
    ‚îú‚îÄ‚îÄ test_auth_login.py
    ‚îú‚îÄ‚îÄ test_auth_verification.py
    ‚îú‚îÄ‚îÄ test_password_reset.py
    ‚îú‚îÄ‚îÄ test_onboarding.py
    ‚îú‚îÄ‚îÄ test_invitations.py
    ‚îú‚îÄ‚îÄ test_rbac.py
    ‚îú‚îÄ‚îÄ test_multi_tenancy.py
    ‚îî‚îÄ‚îÄ test_security.py
```

---

## üöÄ Implementation Plan

### **Sprint 1: Authentication Core (Stories 1.1-1.3)**
**Duration:** 1-2 weeks  
**Stories:** 1.1, 1.2, 1.3  
**Deliverables:**
- User signup with email verification
- Login with JWT tokens
- RBAC middleware and authorization

**Critical Path:**
1. Story 1.1 (Signup) ‚Üí Email verification working
2. Story 1.2 (Login) ‚Üí JWT tokens working
3. Story 1.3 (RBAC) ‚Üí Protected endpoints working

---

### **Sprint 2: User Flows (Stories 1.4-1.5)**
**Duration:** 1 week  
**Stories:** 1.4, 1.5  
**Deliverables:**
- Password reset flow
- User onboarding and company creation

---

### **Sprint 3: Team Collaboration (Stories 1.6-1.7)**
**Duration:** 1 week  
**Stories:** 1.6, 1.7  
**Deliverables:**
- Team invitation system
- Invitation acceptance
- Multi-company support

---

### **Sprint 4: Testing & Hardening (Story 1.8)**
**Duration:** 3-5 days  
**Stories:** 1.8  
**Deliverables:**
- Comprehensive test suite
- Data isolation verification
- Security validation
- Performance optimization

---

## ‚úÖ Acceptance Criteria Totals

| Phase | Stories | Total AC | Completed |
|-------|---------|----------|-----------|
| Phase 1 | 0.1-0.3 | 30 | ‚úÖ 30/30 |
| Phase 2 | 1.1-1.3 | 30 | 0/30 |
| Phase 3 | 1.4-1.7 | 40 | 0/40 |
| Phase 4 | 1.8 | 10 | 0/10 |
| **TOTAL** | **11 stories** | **110 AC** | **30/110 (27%)** |

---

## üìä Progress Tracking

**Completed:**
- ‚úÖ Phase 1 complete (Stories 0.1, 0.2, 0.3)
- ‚úÖ Database models (33 models, 45 tables)
- ‚úÖ Logging infrastructure
- ‚úÖ Email service

**Next Up:**
- üìù Story 1.1: User Signup & Email Verification
- üìù Story 1.2: Login & JWT Tokens
- üìù Story 1.3: RBAC Middleware & Authorization

---

## üéØ Success Metrics

**Phase 2 Complete When:**
- [ ] Users can signup and verify email
- [ ] Users can login and receive JWT tokens
- [ ] Protected endpoints require authentication
- [ ] Role-based authorization works
- [ ] All tests passing

**Phase 3 Complete When:**
- [ ] Users can reset forgotten passwords
- [ ] Users can complete onboarding
- [ ] Company admins can invite team members
- [ ] Invited users can accept and join
- [ ] Multi-company support works

**Phase 4 Complete When:**
- [ ] Data isolation verified (no cross-company access)
- [ ] All role checks enforced
- [ ] Security tests passing
- [ ] Performance acceptable
- [ ] Ready for production

---

## üìö Documentation Created

**Story Files:** (11 files)
- `docs/stories/story-0.1.md` ‚úÖ
- `docs/stories/story-0.2.md` ‚úÖ
- `docs/stories/story-0.3.md` ‚úÖ
- `docs/stories/story-1.1.md` ‚úÖ
- `docs/stories/story-1.2.md` ‚úÖ
- `docs/stories/story-1.3.md` ‚úÖ
- `docs/stories/story-1.4.md` ‚úÖ
- `docs/stories/story-1.5.md` ‚úÖ
- `docs/stories/story-1.6.md` ‚úÖ
- `docs/stories/story-1.7.md` ‚úÖ
- `docs/stories/story-1.8.md` ‚úÖ

**Context Files:** (To be generated as needed)
- `docs/story-context-0.1.xml` ‚úÖ
- `docs/story-context-0.2.xml` ‚úÖ
- `docs/story-context-0.3.xml` ‚úÖ
- `docs/story-context-1.1.xml` - Ready to generate
- `docs/story-context-1.2.xml` - Ready to generate
- `docs/story-context-1.3.xml` - Ready to generate
- `docs/story-context-1.4.xml` - Ready to generate
- `docs/story-context-1.5.xml` - Ready to generate
- `docs/story-context-1.6.xml` - Ready to generate
- `docs/story-context-1.7.xml` - Ready to generate
- `docs/story-context-1.8.xml` - Ready to generate

---

## üéâ Ready for Implementation!

All stories are fully documented with:
- ‚úÖ Clear acceptance criteria
- ‚úÖ Detailed tasks and subtasks
- ‚úÖ Architecture patterns and code examples
- ‚úÖ Security considerations
- ‚úÖ Testing requirements
- ‚úÖ Dependencies identified
- ‚úÖ Implementation sequence defined

**Amelia (Developer Agent) can now proceed with implementation following the correct sequence!**

---

**Generated by:** Sarah (Product Owner Agent)  
**Date:** 2025-10-16  
**Epic:** Epic 1 - Authentication & Onboarding  
**Status:** Complete Story Breakdown Ready

