<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>12</storyId>
    <title>International Foundation & Country-Specific Validation</title>
    <status>Approved</status>
    <generatedAt>2025-10-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-1.12.md</sourceStoryPath>
  </metadata>

  <acceptance_criteria>
    <ac id="AC-1.12.1" priority="high">
      <statement>Australian phone number validation enforced</statement>
      <validation>
        <method>Unit Test</method>
        <success_condition>Valid formats accepted (+61412345678, 0412345678); invalid formats rejected with clear error message</success_condition>
      </validation>
    </ac>
    <ac id="AC-1.12.2" priority="high">
      <statement>Australian address validation with state/postcode</statement>
      <validation>
        <method>Unit Test</method>
        <success_condition>Valid states (NSW, VIC, QLD, etc.); postcode ranges validated; invalid combinations rejected</success_condition>
      </validation>
    </ac>
    <ac id="AC-1.12.3" priority="high">
      <statement>ABN/ACN validation with checksum algorithm</statement>
      <validation>
        <method>Unit Test</method>
        <success_condition>Valid ABN (11-digit with checksum) accepted; invalid ABN rejected; ACN (9-digit) validated</success_condition>
      </validation>
    </ac>
    <ac id="AC-1.12.4" priority="high">
      <statement>Email validation using RFC 5322 standard</statement>
      <validation>
        <method>Unit Test</method>
        <success_condition>Valid email formats accepted; invalid formats rejected; internationalized domains supported</success_condition>
      </validation>
    </ac>
    <ac id="AC-1.12.5" priority="high">
      <statement>Validation API endpoint provides real-time validation</statement>
      <validation>
        <method>Integration Test</method>
        <success_condition>POST /api/validation/validate accepts field, value, country; returns valid, message, formatted value</success_condition>
      </validation>
    </ac>
    <ac id="AC-1.12.6" priority="medium">
      <statement>ValidationRule table stores country-specific rules</statement>
      <validation>
        <method>Database Query</method>
        <success_condition>Rules for AU stored with regex patterns, error messages, formatting rules</success_condition>
      </validation>
    </ac>
    <ac id="AC-1.12.7" priority="medium">
      <statement>User-friendly error messages with examples</statement>
      <validation>
        <method>Integration Test</method>
        <success_condition>Errors include example format (e.g., "Invalid phone. Try: +61412345678"); helpful, not technical</success_condition>
      </validation>
    </ac>
    <ac id="AC-1.12.8" priority="high">
      <statement>Formatted values returned for display</statement>
      <validation>
        <method>Unit Test</method>
        <success_condition>Phone formatted as +61 412 345 678; ABN as 12 345 678 901; consistent formatting</success_condition>
      </validation>
    </ac>
  </acceptance_criteria>

  <dependencies>
    <dependency type="story" status="completed">
      <id>Story 0.1</id>
      <description>Database Models - Provides ValidationRule table</description>
    </dependency>
    <dependency type="story" status="ready">
      <id>Story 1.13</id>
      <description>Configuration Service - Provides validation rule queries</description>
    </dependency>
  </dependencies>

  <notes>
    <note type="implementation">
      Use python-phonenumbers library for phone validation (supports 200+ countries). ABN checksum: Subtract 1 from first digit, multiply each digit by weights [10,1,3,5,7,9,11,13,15,17,19], sum mod 89 should equal 0. Store validation rules in ValidationRule table for runtime configurability.
    </note>
    <note type="internationalization">
      Epic 1 focuses on Australia only. ValidationRule table designed for future countries (US, UK, NZ, etc.). CountryCode field allows country-specific rules. Future enhancement: Auto-detect country from IP address.
    </note>
    <note type="ux">
      Real-time validation significantly improves form completion rates. Show validation feedback immediately (debounce 300ms). Use green checkmarks for valid fields, red X for invalid. Provide example formats in error messages.
    </note>
    <note type="performance">
      Cache validation rules (5-minute TTL). Validation should respond <100ms. Use regex for most validations (fast). Complex validations (ABN checksum) should be optimized.
    </note>
    <note type="future">
      Future enhancements: (1) Add US validation (SSN, ZIP, phone), (2) Add UK validation (postcode, phone), (3) Add NZ validation (IRD, phone), (4) Auto-format as user types (frontend), (5) Lookahead suggestions for addresses.
    </note>
  </notes>
</story-context>

