<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <epic-id>1</epic-id>
    <story-id>15</story-id>
    <story-title>Activity Logging and Audit Trail</story-title>
    <story-status>Draft</story-status>
    <created-date>2025-10-13</created-date>
    <context-version>1.0</context-version>
  </metadata>

  <user-story>
    <as-a>EventLead Platform system</as-a>
    <i-want>to implement comprehensive activity logging and audit trail functionality</i-want>
    <so-that>all user actions and system events are tracked for compliance, debugging, and security monitoring</so-that>
  </user-story>

  <acceptance-criteria>
    <criterion id="AC-15.1">System logs all authentication events (signup, login, logout, password reset)</criterion>
    <criterion id="AC-15.2">System logs all user management activities (profile updates, role changes)</criterion>
    <criterion id="AC-15.3">System logs all company management activities (creation, updates, team changes)</criterion>
    <criterion id="AC-15.4">System logs all invitation activities (creation, acceptance, cancellation)</criterion>
    <criterion id="AC-15.5">System logs all authorization events (access attempts, permission changes)</criterion>
    <criterion id="AC-15.6">System logs all data access and modification events</criterion>
    <criterion id="AC-15.7">System provides structured logging with consistent format</criterion>
    <criterion id="AC-15.8">System implements log retention and archival policies</criterion>
    <criterion id="AC-15.9">System provides log search and filtering capabilities</criterion>
    <criterion id="AC-15.10">System implements log security and access control</criterion>
  </acceptance-criteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="AC-15: Activity Logging">
        <snippet>AC-15.1: System logs all authentication events (signup, login, logout, password reset)
AC-15.2: System logs all user management activities (profile updates, role changes)
AC-15.3: System logs all company management activities (creation, updates, team changes)
AC-15.4: System logs all invitation activities (creation, acceptance, cancellation)
AC-15.5: System logs all authorization events (access attempts, permission changes)</snippet>
      </doc>
      <doc path="docs/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="Log Structure and Format">
        <snippet>Log Structure and Format:
{
  "timestamp": "2025-10-13T10:30:00Z",
  "event_type": "user_login",
  "user_id": "123",
  "company_id": "456",
  "ip_address": "192.168.1.1",
  "user_agent": "Mozilla/5.0...",
  "metadata": {
    "login_method": "email",
    "success": true
  }
}</snippet>
      </doc>
    </docs>

    <code>
      <file path="backend/modules/audit/activity_logger.py" kind="file" symbol="activity_logger" lines="0" reason="Activity logger - needs comprehensive activity logging for all system events"/>
      <file path="backend/modules/audit/audit_service.py" kind="file" symbol="audit_service" lines="0" reason="Audit service - needs audit trail management and log retention"/>
      <file path="frontend/src/features/audit/components/ActivityLogViewer.tsx" kind="file" symbol="activity_log_viewer" lines="0" reason="Activity log viewer component - needs log search and filtering interface"/>
      <file path="frontend/src/features/audit/components/LogFilter.tsx" kind="file" symbol="log_filter" lines="0" reason="Log filter component - needs log filtering and search capabilities"/>
    </code>

    <dependencies>
      <ecosystem name="python">
        <package name="structlog" version="24.4.0" purpose="Structured logging with consistent format"/>
        <package name="fastapi" version="0.115.7" purpose="Web framework for audit endpoints"/>
        <package name="sqlalchemy" version="2.0.40" purpose="ORM for activity log data operations"/>
        <package name="pydantic" version="2.10.6" purpose="Request/response validation for audit operations"/>
      </ecosystem>
      <ecosystem name="node">
        <package name="react" version="18.2.0" purpose="Frontend UI framework"/>
        <package name="axios" version="1.6.2" purpose="HTTP client for audit API calls"/>
        <package name="date-fns" version="2.30.0" purpose="Date utilities for log filtering"/>
      </ecosystem>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface name="activity_logger" kind="Service" signature="def log_activity(event_type: str, user_id: str, metadata: dict)" path="backend/modules/audit/activity_logger.py">
      <description>Activity logger service for comprehensive event logging</description>
    </interface>
    <interface name="audit_service" kind="Service" signature="def get_audit_trail(filters: dict) -> list" path="backend/modules/audit/audit_service.py">
      <description>Audit service for log retrieval and management</description>
    </interface>
    <interface name="log_search_endpoint" kind="REST API" signature="GET /api/audit/logs" path="backend/modules/audit/router.py">
      <description>Log search endpoint with filtering capabilities</description>
    </interface>
    <interface name="activity_log_viewer" kind="React Component" signature="ActivityLogViewer" path="frontend/src/features/audit/components/ActivityLogViewer.tsx">
      <description>Activity log viewer component for log display and search</description>
    </interface>
    <interface name="log_filter" kind="React Component" signature="LogFilter" path="frontend/src/features/audit/components/LogFilter.tsx">
      <description>Log filter component for search and filtering capabilities</description>
    </interface>
  </interfaces>

  <constraints>
    <constraint type="audit">Comprehensive Logging: All user actions and system events tracked</constraint>
    <constraint type="audit">Structured Logging: Consistent format with metadata and context</constraint>
    <constraint type="security">Log Retention: Configurable retention policies with archival</constraint>
    <constraint type="security">Log Security: Encrypted storage with access control</constraint>
    <constraint type="performance">Performance: Efficient logging with minimal impact on operations</constraint>
    <constraint type="compliance">Compliance: Audit trail for regulatory and security requirements</constraint>
    <constraint type="testing">Unit Tests: 80%+ coverage for activity logging module using pytest</constraint>
    <constraint type="testing">Integration Tests: Complete logging flow using TestClient</constraint>
    <constraint type="testing">E2E Tests: Browser log management using Playwright</constraint>
  </constraints>

  <tests>
    <standards>
      Testing follows pytest framework for backend unit tests, React Testing Library for frontend component tests, and Playwright for E2E testing.
      Unit tests require 80%+ coverage for activity logging module. Integration tests cover complete logging flow using FastAPI TestClient.
      E2E tests use Playwright for browser log management and audit trail validation.
    </standards>
    <locations>
      <location>backend/tests/</location>
      <location>frontend/src/**/*.test.tsx</location>
      <location>tests/e2e/</location>
    </locations>
    <ideas>
      <test ac-id="AC-15.1" type="unit" description="Test authentication event logging (signup, login, logout, password reset)"/>
      <test ac-id="AC-15.2" type="unit" description="Test user management activity logging (profile updates, role changes)"/>
      <test ac-id="AC-15.3" type="unit" description="Test company management activity logging (creation, updates, team changes)"/>
      <test ac-id="AC-15.4" type="unit" description="Test invitation activity logging (creation, acceptance, cancellation)"/>
      <test ac-id="AC-15.5" type="unit" description="Test authorization event logging (access attempts, permission changes)"/>
      <test ac-id="AC-15.6" type="unit" description="Test data access and modification event logging"/>
      <test ac-id="AC-15.7" type="unit" description="Test structured logging with consistent format"/>
      <test ac-id="AC-15.8" type="unit" description="Test log retention and archival policies"/>
      <test ac-id="AC-15.9" type="e2e" description="Test log search and filtering capabilities"/>
      <test ac-id="AC-15.10" type="unit" description="Test log security and access control"/>
    </ideas>
  </tests>
</story-context>
